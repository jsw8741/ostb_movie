<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout1}">
<head>
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<th:block layout:fragment="css">
	<style>
/* 스타일 설정 */
</style>
</th:block>

<div layout:fragment="content">
	<div class="bg-light py-3">
		<div class="container">
			<div class="row">
				<div class="col-md-12 mb-0 header_margin">
					<a href="/">Home</a> <span class="mx-2 mb-0">/</span> <strong
						class="text-black">장바구니</strong>
				</div>
			</div>
		</div>
		<div class="site-section">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<h2 class="h3 mb-3 text-black">장바구니</h2>
						<div class="p-3 p-lg-5 border"></div>
						<form th:action="@{/order/cartsign}" method="post" id="formcart">
							<div th:each="cart, status : ${carts}">
								<label> <input type="checkbox" id="userCoupon"
									th:name="selectedItems" th:value="${cart.id}" /> <span
									th:text="${cart.itemId.itemNm}"></span> <span
									th:text="${cart.itemId.price}"></span>
								</label>
							</div>
							<button type="submit">선택한 항목 주문하기</button>
							<input type="hidden" th:name="${_csrf.parameterName}"
								th:value="${_csrf.token}" /> <input type="hidden" id="apibtn"
								value="2124" /> <input type="hidden" id="ssds" value="212422" />
							<button type="button" id="kakao-pay">카카오페이로 결제하기</button>
						</form>
						<h2 id="totalPrice" class="text-primary h4"></h2>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<th:block layout:fragment="script">
	<script th:inline="javascript">
	const userCouponCheckboxes = document.querySelectorAll("input[id='userCoupon']"); // 모든 userCoupon 체크박스 가져오기
	const totalPriceElement = document.getElementById("totalPrice"); // totalPrice 엘리먼트 가져오기
	let totalSelectedPrice = 0; // 초기 상품 가격 합계 설정

	userCouponCheckboxes.forEach(function(userCouponCheckbox) {
	    userCouponCheckbox.addEventListener("click", function() {
	        const productPrice = parseInt(userCouponCheckbox.parentElement.querySelector("span:last-child").textContent); // 체크박스 옆에 있는 상품 가격 가져오기
	        if (userCouponCheckbox.checked) {
	            totalSelectedPrice += productPrice;
	        } else {
	            totalSelectedPrice -= productPrice;
	        }
	        totalPriceElement.textContent = "선택한 상품 가격 합계: " + totalSelectedPrice + "원";
	    });
	});
		$(function() {
			$("#kakao-pay").click(
					function() {

						// 필수입력값을 확인.
						//var name = $("#form-payment input[name='pay-name']").val();

						// 결제 정보를 form에 저장한다.
						let totalPayPrice = parseInt($("#total-pay-price")
								.text().replace(/,/g, ''))
						let totalPrice = parseInt($("#total-price").text()
								.replace(/,/g, ''))
						let usePoint = $("#point-use").val()
						let useUserCouponNo = $(
								":radio[name='userCoupon']:checked").val()
						alert(totalPayPrice);

						// 카카오페이 결제전송
						$.ajax({
							type : '',
							url : '/pay/ready',
							data : {
								total_amount : totalPayPrice,
								payUserName : name,
								sumPrice : totalPrice,
								discountPrice : discountPrice,
								totalPrice : totalPayPrice
							},
							success : function(response) {
								location.href = response.next_redirect_pc_url
							}
						})
					})
		})
	</script>

</th:block>
</html>
