<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout1}">
<head>
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<th:block layout:fragment="css">
	<style>
/* 스타일 설정 */
</style>
</th:block>

<div layout:fragment="content">
	<div class="bg-light py-3">
		<div class="container">
			<div class="row">
				<div class="col-md-12 mb-0 header_margin">
					<a href="/">Home</a> <span class="mx-2 mb-0">/</span> <strong
						class="text-black">장바구니</strong>
				</div>
			</div>
		</div>
		<div class="site-section">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<h2 class="h3 mb-3 text-black">장바구니</h2>
						<div class="p-3 p-lg-5 border"></div>
						<form th:action="@{/order/cartsign}" method="post" id="formcart">
							<div th:each="cart, status : ${carts}">
								<label> <input type="checkbox" id="userCoupon"
									th:name="selectedItems" th:value="${cart.id}" /> <span
									th:text="${cart.itemId.itemNm}"></span> <span
									th:text="${cart.count}"></span> <span
									th:text="${cart.itemId.price}"></span>
								</label>
							</div>
							<button type="submit">선택한 항목 주문하기</button>
							<input type="hidden" th:name="${_csrf.parameterName}"
								th:value="${_csrf.token}" /> <input type="hidden"
								value="2124" /> <input type="hidden" id="ssds" value="212422" />
							<button type="button" id="apibtn">카카오페이로 결제하기</button>
						</form>
						<h2 id="totalPrice" class="text-primary h4"></h2>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<th:block layout:fragment="script">
	<script th:inline="javascript">
		document.addEventListener("DOMContentLoaded", function() {
			totalPriceElement.textContent = "선택한 상품 가격 합계: "
					+ totalSelectedPrice + "원";
		});
		const userCouponCheckboxes = document
				.querySelectorAll("input[id='userCoupon']"); // 모든 userCoupon 체크박스 가져오기
		const totalPriceElement = document.getElementById("totalPrice"); // totalPrice 엘리먼트 가져오기
		let totalSelectedPrice = 0; // 초기 상품 가격 합계 설정

		userCouponCheckboxes.forEach(function(userCouponCheckbox) {
			userCouponCheckbox.addEventListener("click", function() {
				const productPrice = parseInt(userCouponCheckbox.parentElement
						.querySelector("span:last-child").textContent);
				const productCount = parseInt(userCouponCheckbox.parentElement
						.querySelector("span:nth-child(3)").textContent);
				// 체크박스 옆에 있는 상품 가격과 수량 가져오기
				if (userCouponCheckbox.checked) {
					totalSelectedPrice += productPrice * productCount;
				} else {
					totalSelectedPrice -= productPrice * productCount;
				}
				totalPriceElement.textContent = "선택한 상품 가격 합계: "
						+ totalSelectedPrice.toLocaleString() + "원";
			});
		});

		$(document).on("click", "#apibtn", function(){
			var totalPrice = document.getElementById("totalPrice").value;
			
			
		    var data = {
		    		totalPrice : totalPrice
		        };
			
			$.ajax({
				
			    type: 'GET',
			    url: '/pay/ready',
			    contentType: 'application/x-www-form-urlencoded;charset=utf-8',
			    data: data,
				success:function(res){
		            var box = res.next_redirect_pc_url;
		            var popupWidth = 500;
		            var popupHeight = 800;
		            var left = (screen.width - popupWidth) / 2;
		            var top = (screen.height - popupHeight) / 2;
		            var popupOptions = "width=" + popupWidth + ",height=" + popupHeight + ",top=" + top + ",left=" + left;
		            window.open(box, "KakaoPay", popupOptions);
					
					
				}
			})
		});
	 	
	</script>


	</th:block>
	</html>